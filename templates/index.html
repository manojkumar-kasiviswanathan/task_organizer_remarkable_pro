<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task Organizer</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='remarkable.css') }}?v=11">
</head>

<body data-today="{{ today }}" data-theme="light">
  <div id="bg-doodle"></div>

  <div id="page">
<header class="masthead sticky center-head">
  <div class="masthead-row">
    <!-- Left spacer -->
    <div class="mast-left"></div>

    <!-- Center brand -->
    <div class="brand center">
      <div class="logo" aria-hidden="true">‚òëÔ∏è</div>
      <div class="titles">
        <h1>Task Organizer</h1>
        <p class="subtitle">Local ¬∑ Private ¬∑ Fast</p>
      </div>
    </div>

    <!-- Tools right -->
    <div class="mast-tools">
      <button id="refreshBtn" class="icon-btn" title="Reload">‚Ü∫</button>
      <button id="themeToggle" class="icon-btn"
              data-icon-light="üåô" data-icon-dark="‚òÄÔ∏è"
              aria-label="Toggle theme">üåô</button>
    </div>
  </div>
</header>


    <!-- TODAY -->
    <section class="card card-first">
      <h2>Today ‚Äî {{ today_display }}</h2>

      <div class="grid head five">
        <div class="th">TASK</div>
        <div class="th">STATUS</div>
        <div class="th">TAGS</div>
        <div class="th">DEADLINE</div>
        <div class="th">COMMENT</div>
      </div>

      <div class="draggable" data-date="{{ today }}">
        {% for idx, task in today_active %}
        {% set scls = task['status']|replace(' ', '')|lower() %}
        {% set due = task.get('due','') %}
        {% set due_class = 'due-none' %}
        {% if due == iso_yesterday %}{% set due_class = 'due-warn' %}{% endif %}
        {% if due == iso_today %}{% set due_class = 'due-danger' %}{% endif %}

        <div class="grid row item five" draggable="true" data-index="{{ idx }}">
          <!-- TASK -->
          <div class="cell">
            <form method="POST" action="{{ url_for('change_task_name', task_date=today, task_index=idx) }}">
              <input type="text" name="task" value="{{ task['task'] }}" placeholder="Task title‚Ä¶"
                onkeydown="if(event.key==='Enter'){ this.form.submit(); return false; }" onchange="this.form.submit()">
            </form>
          </div>

          <!-- STATUS -->
          <div class="cell status-cell">
            <span class="status-dot {{ scls }}"></span>
            <form method="POST" action="{{ url_for('change_status', task_date=today, task_index=idx) }}">
              <select name="status" onchange="this.form.submit()">
                {% for s in statuses %}
                <option value="{{ s }}" {% if task['status']==s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
              </select>
            </form>
          </div>

          <!-- TAGS -->
          <div class="cell">
            <div class="tags-editor" data-date="{{ today }}" data-index="{{ idx }}">
              <div class="tags-view">
                {% for tag in (task.get('tags','') or '').split(',') if tag.strip() %}
                <button type="button" class="tag-pill" data-tag="{{ tag.strip() }}"
                  data-n="{{ '%02d' % (loop.index) }}">
                  {{ tag.strip() }} <span class="tag-x" aria-label="Remove">√ó</span>
                </button>
                {% endfor %}
              </div>
              <form class="tags-form" method="POST"
                action="{{ url_for('change_tags', task_date=today, task_index=idx) }}">
                <input type="hidden" name="tags" value="{{ task.get('tags','') }}">
                <button type="button" class="tag-add-btn">+</button>
              </form>
            </div>
          </div>

          <!-- DEADLINE (custom dd/mm/yyyy + clear) -->
          <div class="cell">
            <form method="POST" action="{{ url_for('change_due', task_date=today, task_index=idx) }}">
              <div class="due-chip {{ due_class }}">
                <input type="text" class="date-display" value="{{ due and (due|fmt_date) or '' }}"
                  placeholder="dd/mm/yyyy" readonly>
                <input type="hidden" name="due" value="{{ due }}">
                <button type="button" class="due-clear" title="Clear date">√ó</button>
              </div>
            </form>
          </div>

          <!-- COMMENT (Markdown editable) -->
          <div class="cell">
            <form method="POST" action="{{ url_for('change_comment', task_date=today, task_index=idx) }}">
              <textarea class="comment-ta" name="comment" rows="2" placeholder="Add a note‚Ä¶ (Markdown supported)"
                onkeydown="if(event.key==='Enter' && (event.metaKey||event.ctrlKey)){ this.form.submit(); return false; }"
                onchange="this.form.submit()">{{ task['comment'] }}</textarea>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>

      {% if today_completed %}
      <h3 class="muted group-title">Completed</h3>
      <div class="draggable completed-group" data-date="{{ today }}">
        {% for idx, task in today_completed %}
        {% set scls = task['status']|replace(' ', '')|lower() %}
        {% set due = task.get('due','') %}
        {% set due_class = 'due-none' %}
        {% if due == iso_yesterday %}{% set due_class = 'due-warn' %}{% endif %}
        {% if due == iso_today %}{% set due_class = 'due-danger' %}{% endif %}
        <div class="grid row item five" draggable="true" data-index="{{ idx }}">
          <div class="cell completed">{{ task['task'] }}</div>
          <div class="cell status-cell">
            <span class="status-dot {{ scls }}"></span>
            <span class="status-badge status-{{ scls }}">{{ task['status'] }}</span>
          </div>
          <div class="cell">
            <div class="tags-view">
              {% for tag in (task.get('tags','') or '').split(',') if tag.strip() %}
              <span class="tag-pill" data-tag="{{ tag.strip() }}" data-n="{{ '%02d' % (loop.index) }}">{{ tag.strip()
                }}</span>
              {% endfor %}
            </div>
          </div>
          <div class="cell"><span class="due-chip {{ due_class }}">{{ due and (due|fmt_date) or '‚Äî' }}</span></div>
          <div class="cell">
            <div class="md">{{ task['comment'] }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Add new -->
      <form class="add grid five" method="POST" action="{{ url_for('add_task', task_date=today) }}">
        <input type="text" name="task" placeholder="New task‚Ä¶" required />
        <select name="status" disabled>
          <option selected>New</option>
        </select>
        <input type="hidden" name="tags" value="">
        <input type="date" name="due" />
        <input type="text" name="comment" placeholder="Comment (optional)" />
        <button type="submit">Add</button>
      </form>
    </section>

    <!-- YESTERDAY (read-only) -->
    <section class="card">
      <h2>Yesterday ‚Äî {{ yesterday_display }}</h2>
      <div class="grid head five">
        <div class="th">TASK</div>
        <div class="th">STATUS</div>
        <div class="th">TAGS</div>
        <div class="th">DEADLINE</div>
        <div class="th">COMMENT</div>
      </div>

      {% for task in yesterday_active %}
      {% set scls = task['status']|replace(' ', '')|lower() %}
      {% set due = task.get('due','') %}
      {% set due_class = 'due-none' %}
      {% if due == iso_yesterday %}{% set due_class = 'due-warn' %}{% endif %}
      {% if due == iso_today %}{% set due_class = 'due-danger' %}{% endif %}
      <div class="grid row five">
        <div class="cell">{{ task['task'] }}</div>
        <div class="cell status-cell">
          <span class="status-dot {{ scls }}"></span>
          <span class="status-badge status-{{ scls }}">{{ task['status'] }}</span>
        </div>
        <div class="cell">
          <div class="tags-view">
            {% for tag in (task.get('tags','') or '').split(',') if tag.strip() %}
            <span class="tag-pill" data-tag="{{ tag.strip() }}" data-n="{{ '%02d' % (loop.index) }}">{{ tag.strip()
              }}</span>
            {% endfor %}
          </div>
        </div>
        <div class="cell"><span class="due-chip {{ due_class }}">{{ due and (due|fmt_date) or '‚Äî' }}</span></div>
        <div class="cell">
          <div class="md">{{ task['comment'] }}</div>
        </div>
      </div>
      {% endfor %}

      {% if yesterday_completed %}
      <h3 class="muted group-title">Completed</h3>
      {% for task in yesterday_completed %}
      {% set scls = task['status']|replace(' ', '')|lower() %}
      {% set due = task.get('due','') %}
      {% set due_class = 'due-none' %}
      {% if due == iso_yesterday %}{% set due_class = 'due-warn' %}{% endif %}
      {% if due == iso_today %}{% set due_class = 'due-danger' %}{% endif %}
      <div class="grid row five">
        <div class="cell completed">{{ task['task'] }}</div>
        <div class="cell status-cell">
          <span class="status-dot {{ scls }}"></span>
          <span class="status-badge status-{{ scls }}">{{ task['status'] }}</span>
        </div>
        <div class="cell">
          <div class="tags-view">
            {% for tag in (task.get('tags','') or '').split(',') if tag.strip() %}
            <span class="tag-pill" data-tag="{{ tag.strip() }}" data-n="{{ '%02d' % (loop.index) }}">{{ tag.strip()
              }}</span>
            {% endfor %}
          </div>
        </div>
        <div class="cell"><span class="due-chip {{ due_class }}">{{ due and (due|fmt_date) or '‚Äî' }}</span></div>
        <div class="cell">
          <div class="md">{{ task['comment'] }}</div>
        </div>
      </div>
      {% endfor %}
      {% endif %}
    </section>

    <!-- ARCHIVES -->
    <section class="card">
      <h2>Archives</h2>
      <div class="accordion">
        {% for day, tasks in archives.items() %}
        {% set a_active = tasks | selectattr('status', 'ne', 'Complete') | list %}
        {% set a_done = tasks | selectattr('status', 'equalto', 'Complete') | list %}
        <details class="accordion-item">
          <summary>
            <span class="archive">{{ day }}</span>
            <span class="badge">{{ tasks|length }}</span>
          </summary>

          <div class="grid head five inner">
            <div class="th">TASK</div>
            <div class="th">STATUS</div>
            <div class="th">TAGS</div>
            <div class="th">DEADLINE</div>
            <div class="th">COMMENT</div>
          </div>

          {% for t in a_active %}
          {% set scls = t['status']|replace(' ', '')|lower() %}
          {% set due = t.get('due','') %}
          {% set due_class = 'due-none' %}
          {% if due == iso_yesterday %}{% set due_class = 'due-warn' %}{% endif %}
          {% if due == iso_today %}{% set due_class = 'due-danger' %}{% endif %}
          <div class="grid row five inner">
            <div class="cell">{{ t['task'] }}</div>
            <div class="cell status-cell">
              <span class="status-dot {{ scls }}"></span>
              <span class="status-badge status-{{ scls }}">{{ t['status'] }}</span>
            </div>
            <div class="cell">
              <div class="tags-view">
                {% for tag in (t.get('tags','') or '').split(',') if tag.strip() %}
                <span class="tag-pill" data-tag="{{ tag.strip() }}" data-n="{{ '%02d' % (loop.index) }}">{{ tag.strip()
                  }}</span>
                {% endfor %}
              </div>
            </div>
            <div class="cell"><span class="due-chip {{ due_class }}">{{ due and (due|fmt_date) or '‚Äî' }}</span></div>
            <div class="cell">
              <div class="md">{{ t['comment'] }}</div>
            </div>
          </div>
          {% endfor %}

          {% if a_done %}
          <h4 class="muted group-title inner">Completed</h4>
          {% for t in a_done %}
          {% set scls = t['status']|replace(' ', '')|lower() %}
          {% set due = t.get('due','') %}
          {% set due_class = 'due-none' %}
          {% if due == iso_yesterday %}{% set due_class = 'due-warn' %}{% endif %}
          {% if due == iso_today %}{% set due_class = 'due-danger' %}{% endif %}
          <div class="grid row five inner">
            <div class="cell completed">{{ t['task'] }}</div>
            <div class="cell status-cell">
              <span class="status-dot {{ scls }}"></span>
              <span class="status-badge status-{{ scls }}">{{ t['status'] }}</span>
            </div>
            <div class="cell">
              <div class="tags-view">
                {% for tag in (t.get('tags','') or '').split(',') if tag.strip() %}
                <span class="tag-pill" data-tag="{{ tag.strip() }}" data-n="{{ '%02d' % (loop.index) }}">{{ tag.strip()
                  }}</span>
                {% endfor %}
              </div>
            </div>
            <div class="cell"><span class="due-chip {{ due_class }}">{{ due and (due|fmt_date) or '‚Äî' }}</span></div>
            <div class="cell">
              <div class="md">{{ t['comment'] }}</div>
            </div>
          </div>
          {% endfor %}
          {% endif %}
        </details>
        {% endfor %}
      </div>
    </section>
  </div>

  <!-- Tag Modal -->
  <div class="modal" id="tagModal" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-card">
      <h3>Add tag</h3>
      <input id="tagInput" type="text" placeholder="Type a tag and press Enter">
      <div class="modal-actions">
        <button id="tagCancel">Cancel</button>
        <button id="tagSave">Add</button>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='app.js') }}?v=13"></script>
</body>

</html>