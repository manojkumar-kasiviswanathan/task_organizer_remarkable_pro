<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task Organizer</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='remarkable.css') }}">
</head>

<body>
  <div id="bg-doodle"></div>
  <div id="page">
    <header class="masthead">
      <div class="masthead-row">
        <div>
          <h1>Task Organizer</h1>
          <p class="subtitle">Simple Â· Local Â· Focused</p>
        </div>
        <div class="controls">
          <button id="themeToggle" aria-label="Toggle theme">ðŸŒ™</button>
        </div>
      </div>
    </header>

    <!-- TODAY (draggable) -->
    <section class="card">
      <h2>Today â€” {{ today_display }}</h2>

      <div class="grid head">
        <div>TASK</div>
        <div>STATUS</div>
        <div>TAGS</div>
        <div>COMMENT</div>
      </div>

      <!-- Active tasks (draggable) -->
      <div class="draggable" data-date="{{ today }}">
        {% for idx, task in today_active %}
        {% set scls = task['status']|replace(' ', '')|lower() %}
        <div class="grid row item" draggable="true" data-index="{{ idx }}">
          <div class="cell">{{ task['task'] }}</div>

          <div class="cell status-cell">
            <span class="status-dot {{ scls }}"></span>
            <form method="POST" action="{{ url_for('change_status', task_date=today, task_index=idx) }}">
              <select name="status" onchange="this.form.submit()">
                {% for s in statuses %}
                <option value="{{ s }}" {% if task['status']==s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
              </select>
            </form>
          </div>

          <div class="cell">
            <div class="tags-editor" data-date="{{ today }}" data-index="{{ idx }}">
              <!-- current tags as pills (interactive) -->
              <div class="tags-view">
                {% set taglist=(task.get('tags','') or '').split(',') %}
                {% for tag in taglist if tag.strip() %}
                <button type="button" class="tag-pill tcolor-{{ loop.index0 % 6 }}" data-tag="{{ tag.strip() }}"
                  data-n="{{ '%02d' % (loop.index) }}">
                  {{ tag.strip() }}
                  <span class="tag-x" aria-label="Remove">Ã—</span>
                </button>
                {% endfor %}
              </div>

              <!-- hidden field holds the CSV that is saved -->
              <form class="tags-form" method="POST"
                action="{{ url_for('change_tags', task_date=today, task_index=idx) }}">
                <input type="hidden" name="tags" value="{{ task.get('tags','') }}">
                <input type="text" class="tags-input" placeholder="Add tag and press Enter">
              </form>
            </div>
          </div>

          <div class="cell">
            <form method="POST" action="{{ url_for('change_comment', task_date=today, task_index=idx) }}">
              <input class="comment" type="text" name="comment" value="{{ task['comment'] }}" placeholder="Add a noteâ€¦"
                onchange="this.form.submit()">
            </form>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Completed group -->
      {% if today_completed %}
      <h3 class="muted group-title">Completed</h3>
      <div class="draggable completed-group" data-date="{{ today }}">
        {% for idx, task in today_completed %}
        {% set scls = task['status']|replace(' ', '')|lower() %}
        <div class="grid row item completed" draggable="true" data-index="{{ idx }}">
          <div class="cell completed">{{ task['task'] }}</div>
          <div class="cell status-cell">
            <span class="status-dot {{ scls }}"></span>
            <span class="status-badge status-{{ scls }}">{{ task['status'] }}</span>
          </div>
          <div class="cell">
            <div class="tags-view">
              {% set taglist=(task.get('tags','') or '').split(',') %}
              {% for tag in taglist if tag.strip() %}
              <span class="tag-pill tcolor-{{ loop.index0 % 6 }}" data-n="{{ '%02d' % (loop.index) }}">{{ tag.strip()
                }}</span>
              {% endfor %}
            </div>
          </div>
          <div class="cell">{{ task['comment'] }}</div>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Add new -->
      <form class="add grid" method="POST" action="{{ url_for('add_task', task_date=today) }}">
        <input type="text" name="task" placeholder="New taskâ€¦" required />
        <select name="status" disabled>
          <option selected>New</option>
        </select>
        <input type="text" name="tags" placeholder="Tags (comma separated)" />
        <input type="text" name="comment" placeholder="Comment (optional)" />
        <button type="submit">Add</button>
      </form>
    </section>

    <!-- YESTERDAY (read-only) -->
    <section class="card">
      <h2>Yesterday â€” {{ yesterday_display }}</h2>
      <div class="grid head">
        <div>TASK</div>
        <div>STATUS</div>
        <div>TAGS</div>
        <div>COMMENT</div>
      </div>

      {% for task in yesterday_active %}
      {% set scls = task['status']|replace(' ', '')|lower() %}
      <div class="grid row">
        <div class="cell">{{ task['task'] }}</div>
        <div class="cell status-cell">
          <span class="status-dot {{ scls }}"></span>
          <span class="status-badge status-{{ scls }}">{{ task['status'] }}</span>
        </div>
        <div class="cell">
          <div class="tags-view">
            {% for tag in (task.get('tags','') or '').split(',') if tag.strip() %}
            <span class="tag-pill tcolor-{{ loop.index0 % 6 }}" data-n="{{ '%02d' % (loop.index) }}">{{ tag.strip()
              }}</span>
            {% endfor %}
          </div>
        </div>
        <div class="cell">{{ task['comment'] }}</div>
      </div>
      {% endfor %}

      {% if yesterday_completed %}
      <h3 class="muted group-title">Completed</h3>
      {% for task in yesterday_completed %}
      {% set scls = task['status']|replace(' ', '')|lower() %}
      <div class="grid row">
        <div class="cell completed">{{ task['task'] }}</div>
        <div class="cell status-cell">
          <span class="status-dot {{ scls }}"></span>
          <span class="status-badge status-{{ scls }}">{{ task['status'] }}</span>
        </div>
        <div class="cell">
          <div class="tags-view">
            {% for tag in (task.get('tags','') or '').split(',') if tag.strip() %}
            <span class="tag-pill tcolor-{{ loop.index0 % 6 }}" data-n="{{ '%02d' % (loop.index) }}">{{ tag.strip()
              }}</span>
            {% endfor %}
          </div>
        </div>
        <div class="cell">{{ task['comment'] }}</div>
      </div>
      {% endfor %}
      {% endif %}
    </section>

    <!-- ARCHIVES (read-only, collapsible) -->
    <section class="card">
      <h2>Archives</h2>
      <div class="accordion">
        {% for day, tasks in archives.items() %}
        {% set a_active = tasks | selectattr('status', 'ne', 'Complete') | list %}
        {% set a_done = tasks | selectattr('status', 'equalto', 'Complete') | list %}
        <details class="accordion-item">
          <summary>
            <span class="archive">{{ day }}</span>
            <span class="badge">{{ tasks|length }}</span>
          </summary>

          <div class="grid head inner">
            <div>TASK</div>
            <div>STATUS</div>
            <div>TAGS</div>
            <div>COMMENT</div>
          </div>

          {% for t in a_active %}
          {% set scls = t['status']|replace(' ', '')|lower() %}
          <div class="grid row inner">
            <div class="cell">{{ t['task'] }}</div>
            <div class="cell status-cell">
              <span class="status-dot {{ scls }}"></span>
              <span class="status-badge status-{{ scls }}">{{ t['status'] }}</span>
            </div>
            <div class="cell">
              <div class="tags-view">
                {% for tag in (t.get('tags','') or '').split(',') if tag.strip() %}
                <span class="tag-pill tcolor-{{ loop.index0 % 6 }}" data-n="{{ '%02d' % (loop.index) }}">{{ tag.strip()
                  }}</span>
                {% endfor %}
              </div>
            </div>
            <div class="cell">{{ t['comment'] }}</div>
          </div>
          {% endfor %}

          {% if a_done %}
          <h4 class="muted group-title inner">Completed</h4>
          {% for t in a_done %}
          {% set scls = t['status']|replace(' ', '')|lower() %}
          <div class="grid row inner">
            <div class="cell completed">{{ t['task'] }}</div>
            <div class="cell status-cell">
              <span class="status-dot {{ scls }}"></span>
              <span class="status-badge status-{{ scls }}">{{ t['status'] }}</span>
            </div>
            <div class="cell">
              <div class="tags-view">
                {% for tag in (t.get('tags','') or '').split(',') if tag.strip() %}
                <span class="tag-pill tcolor-{{ loop.index0 % 6 }}" data-n="{{ '%02d' % (loop.index) }}">{{ tag.strip()
                  }}</span>
                {% endfor %}
              </div>
            </div>
            <div class="cell">{{ t['comment'] }}</div>
          </div>
          {% endfor %}
          {% endif %}
        </details>
        {% endfor %}
      </div>
    </section>

    <footer class="footer">
      <p>All data stored locally in <code>tasks.json</code></p>
    </footer>
  </div>

  <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>

</html>